; this is the IM2 routine
; gets called every 1/50 second, i.e. 20ms
; push/pop are in main program


        LD C, AYPortC              ; shared port for AY chip access

; select AY1
        LD B, AYPortSelectB              ; AYSelect
        LD A, 255
        OUT (C), A

; get the Ch1 tone value
; apply delta
        LD HL, (Ch1Pitch)
        LD DE, (Ch1PitchD)
        ADD HL, DE
        LD (Ch1Pitch), HL

; write Ch1 tone to AY chip
        LD B, AYPortSelectB             ; AYSelect
        LD A, channel1ToneL
        OUT (C), A
        LD B, AYPortWriteB              ; AYrw
        OUT (C), L

        LD B, AYPortSelectB
        LD A, channel1ToneH
        OUT (C), A
        LD B, AYPortWriteB
        OUT (C), H

; get the Ch1 volume value
; apply delta
        LD HL, (Ch1Volume)
        LD DE, (Ch1VolumeD)
        ADD HL, DE
        LD (Ch1Volume), HL

        LD A, H
        AND 15

; write Ch1 volume to AY chip
        LD B, AYPortSelectB
        LD H, channel1Volume
        OUT (C), H
        LD B, AYPortWriteB
        OUT (C), A

; get the Ch2 tone value
; apply delta
        LD HL, (Ch2Pitch)
        LD DE, (Ch2PitchD)
        ADD HL, DE
        LD (Ch2Pitch), HL

; write Ch2 tone to AY chip
        LD B, AYPortSelectB
        LD A, channel2ToneL
        OUT (C), A
        LD B, AYPortWriteB
        OUT (C), L

        LD B, AYPortSelectB
        LD A, channel2ToneH
        OUT (C), A
        LD B, AYPortWriteB
        OUT (C), H

; get the Ch2 volume value
; apply delta
        LD HL, (Ch2Volume)
        LD DE, (Ch2VolumeD)
        ADD HL, DE
        LD (Ch2Volume), HL

        LD A, H
        AND 15

; write Ch2 volume to AY chip
        LD B, AYPortSelectB
        LD H, channel2Volume
        OUT (C), H
        LD B, AYPortWriteB
        OUT (C), A

; get the Ch3 tone value
; apply delta
        LD HL, (Ch3Pitch)
        LD DE, (Ch3PitchD)
        ADD HL, DE
        LD (Ch3Pitch), HL

; write Ch3 tone to AY chip
        LD B, AYPortSelectB
        LD A, channel3ToneL
        OUT (C), A
        LD B, AYPortWriteB
        OUT (C), L

        LD B, AYPortSelectB
        LD A, channel3ToneH
        OUT (C), A
        LD B, AYPortWriteB
        OUT (C), H

; get the Ch3 volume value
; apply delta
        LD HL, (Ch3Volume)
        LD DE, (Ch3VolumeD)
        ADD HL, DE
        LD (Ch3Volume), HL

        LD A, H
        AND 15

; write Ch3 volume to AY chip
        LD B, AYPortSelectB
        LD H, channel3Volume
        OUT (C), H
        LD B, AYPortWriteB
        OUT (C), A

; set the AY mixer value depending on ch1Flags, ch2Flags & ch3Flags
; these control the tone and noise flags in main AY mixer setting
; mapping is as follows and we negate the Ch1/2/3Flag setting
; Ch1Flags
; bit
; 0 -> 0
; 1 -> 3
; Ch2Flags
; 0 -> 1
; 1 -> 4
; Ch3Flags
; 0 -> 2
; 1 -> 5
        LD C, 255                               ; initialise to all 1's, everything off
        LD HL, mixerFlags                       ; point to mapping data for Ch1Flags
        LD A, (Ch1Flags)                        ; get Ch1Flags setting
        AND %00000011                           ; we're only interested in bits 0,1
        ADD HL, A                               ; offset into mixerFlags mapping
        LD A, (HL)                              ; get value
        AND C                                   ; AND with existing
        LD C, A                                 ; store back

        LD HL, mixerFlags +4
        LD A, (Ch2Flags)
        AND %00000011
        ADD HL, A
        LD A, (HL)
        AND C
        LD C, A
        LD HL, mixerFlags +8
        LD A, (Ch3Flags)
        AND %00000011
        ADD HL, A
        LD A, (HL)
        AND C
        LD BC, AYSelect
        LD D, mixerFlag
        OUT (C), D
        LD BC, AYrw
        OUT (C), A
        
        LD A, (Ch1Length)
        DEC A
        JR NZ, ch1endskip
        LD (Ch1Flags), A
        LD HL, 0
        LD (Ch1Volume), HL
        LD (Ch1VolumeD), HL
ch1endskip
        LD (Ch1Length), A

        LD A, (Ch2Length)
        DEC A
        JR NZ, ch2endskip
        LD (Ch2Flags), A
        LD HL, 0
        LD (Ch2Volume), HL
        LD (Ch2VolumeD), HL
ch2endskip
        LD (Ch2Length), A

        LD A, (Ch3Length)
        DEC A
        JR NZ, ch3endskip
        LD (Ch3Flags), A
        LD HL, 0
        LD (Ch3Volume), HL
        LD (Ch3VolumeD), HL
ch3endskip
        LD (Ch3Length), A


